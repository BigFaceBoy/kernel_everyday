# swish 计算公式
$$f(x) = x \frac{1}{1+e^{-x}}$$

# half 的内置函数
CUDA对half提供了 __hmul、__hdiv、__hadd、__hneg 等函数操作，那么什么时候应该用CUDA提供的函数，什么时候可以用符号？两者性能是否有差异？
于是用了两种方式计算swish
```
__device__ __forceinline__ half swish_half(half x){
    return x / (half_1 + hexp(-x));
}

__device__ __forceinline__ half swish_half_v2(half x) {
  return __hdiv(x, __hadd(__float2half(1.0f), hexp(__hneg(x))));
}


__global__ void swish_f16_kernel(half *x, half *y, int N){
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    if(idx < N){
        y[idx] = swish_half(x[idx]);
    }
}

__global__ void swish_f16_v2_kernel(half *x, half *y, int N){
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    if(idx < N){
        y[idx] = swish_half_v2(x[idx]);
    }
}

__global__ void swish_f16x2_kernel(half *x, half *y, int N){
    int idx = 2 * (blockIdx.x * blockDim.x + threadIdx.x);
    if(idx + 1 < N){
        half2 reg_x = (reinterpret_cast<half2*>(x + idx))[0];
        half2 reg_y;

        reg_y.x = swish_half(reg_x.x);
        reg_y.y = swish_half(reg_x.y);

        (reinterpret_cast<half2*>(y + idx))[0] = reg_y;
    }
}

__global__ void swish_f16x2_v2_kernel(half *x, half *y, int N){
    int idx = 2 * (blockIdx.x * blockDim.x + threadIdx.x);
    if(idx + 1 < N){
        half2 reg_x = (reinterpret_cast<half2*>(x + idx))[0];
        half2 reg_y;

        reg_y.x = swish_half_v2(reg_x.x);
        reg_y.y = swish_half_v2(reg_x.y);

        (reinterpret_cast<half2*>(y + idx))[0] = reg_y;
    }
}
```
性能测试如下，两者基本没有差异。
# benchmark
-------------------------------------------------------------------------------------
                                        S=1024, K=1024
           out_f32: ['0.02108992  ', '0.33681312  '], time:0.01019073ms
         out_f32x4: ['0.02108992  ', '0.33681312  '], time:0.00935769ms
        out_f32_th: ['0.02108992  ', '0.33681312  '], time:0.02352238ms
-------------------------------------------------------------------------------------
           out_f16: ['0.02108765  ', '0.33691406  '], time:0.01061988ms
        out_f16_v2: ['0.02108765  ', '0.33666992  '], time:0.01056147ms
         out_f16x2: ['0.02108765  ', '0.33691406  '], time:0.00888014ms
      out_f16x2_v2: ['0.02108765  ', '0.33666992  '], time:0.00904512ms
         out_f16x8: ['0.02108765  ', '0.33691406  '], time:0.00917339ms
     out_f16x8pack: ['0.02108765  ', '0.33691406  '], time:0.00912857ms
        out_f16_th: ['0.02108765  ', '0.33666992  '], time:0.02131701ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=2048
           out_f32: ['-0.09270613 ', '-0.06203125 '], time:0.01218414ms
         out_f32x4: ['-0.09270613 ', '-0.06203125 '], time:0.01103950ms
        out_f32_th: ['-0.09270613 ', '-0.06203125 '], time:0.02819824ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.09265137 ', '-0.06204224 '], time:0.01226401ms
        out_f16_v2: ['-0.09265137 ', '-0.06204224 '], time:0.01229095ms
         out_f16x2: ['-0.09265137 ', '-0.06204224 '], time:0.01123500ms
      out_f16x2_v2: ['-0.09265137 ', '-0.06204224 '], time:0.01133084ms
         out_f16x8: ['-0.09265137 ', '-0.06204224 '], time:0.01025033ms
     out_f16x8pack: ['-0.09265137 ', '-0.06204224 '], time:0.00929594ms
        out_f16_th: ['-0.0927124  ', '-0.06204224 '], time:0.02369928ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=4096
           out_f32: ['1.26937675  ', '0.54880714  '], time:0.01663923ms
         out_f32x4: ['1.26937675  ', '0.54880714  '], time:0.01412821ms
        out_f32_th: ['1.26937664  ', '0.54880714  '], time:0.03592443ms
-------------------------------------------------------------------------------------
           out_f16: ['1.26953125  ', '0.54882812  '], time:0.01656795ms
        out_f16_v2: ['1.26953125  ', '0.54882812  '], time:0.01663518ms
         out_f16x2: ['1.26953125  ', '0.54882812  '], time:0.01641870ms
      out_f16x2_v2: ['1.26953125  ', '0.54882812  '], time:0.01644683ms
         out_f16x8: ['1.26953125  ', '0.54882812  '], time:0.01287293ms
     out_f16x8pack: ['1.26953125  ', '0.54882812  '], time:0.01130676ms
        out_f16_th: ['1.26953125  ', '0.54882812  '], time:0.02751732ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=1024
           out_f32: ['-0.25358093 ', '0.86769247  '], time:0.01280379ms
         out_f32x4: ['-0.25358093 ', '0.86769247  '], time:0.01099873ms
        out_f32_th: ['-0.2535809  ', '0.86769247  '], time:0.02829599ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.25341797 ', '0.86816406  '], time:0.01364017ms
        out_f16_v2: ['-0.25366211 ', '0.86767578  '], time:0.01362395ms
         out_f16x2: ['-0.25341797 ', '0.86816406  '], time:0.01047564ms
      out_f16x2_v2: ['-0.25366211 ', '0.86767578  '], time:0.01040530ms
         out_f16x8: ['-0.25341797 ', '0.86816406  '], time:0.01010513ms
     out_f16x8pack: ['-0.25341797 ', '0.86816406  '], time:0.00945735ms
        out_f16_th: ['-0.25366211 ', '0.86767578  '], time:0.02377057ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=2048
           out_f32: ['-0.27533239 ', '0.2096968   '], time:0.01651549ms
         out_f32x4: ['-0.27533239 ', '0.2096968   '], time:0.01423120ms
        out_f32_th: ['-0.27533239 ', '0.2096968   '], time:0.03597975ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.27539062 ', '0.20959473  '], time:0.01669121ms
        out_f16_v2: ['-0.27539062 ', '0.2097168   '], time:0.01666737ms
         out_f16x2: ['-0.27539062 ', '0.20959473  '], time:0.01512480ms
      out_f16x2_v2: ['-0.27539062 ', '0.2097168   '], time:0.01506042ms
         out_f16x8: ['-0.27539062 ', '0.20959473  '], time:0.01217341ms
     out_f16x8pack: ['-0.27539062 ', '0.20959473  '], time:0.01120925ms
        out_f16_th: ['-0.27539062 ', '0.2097168   '], time:0.02734065ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=4096
           out_f32: ['-0.27767149 ', '0.08523725  '], time:0.02522993ms
         out_f32x4: ['-0.27767149 ', '0.08523725  '], time:0.02065587ms
        out_f32_th: ['-0.27767149 ', '0.08523725  '], time:0.05028033ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.27783203 ', '0.08520508  '], time:0.02540183ms
        out_f16_v2: ['-0.27783203 ', '0.08520508  '], time:0.02538061ms
         out_f16x2: ['-0.27783203 ', '0.08520508  '], time:0.02504921ms
      out_f16x2_v2: ['-0.27783203 ', '0.08520508  '], time:0.02505732ms
         out_f16x8: ['-0.27783203 ', '0.08520508  '], time:0.01799059ms
     out_f16x8pack: ['-0.27783203 ', '0.08520508  '], time:0.01469612ms
        out_f16_th: ['-0.27758789 ', '0.08520508  '], time:0.03478169ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=1024
           out_f32: ['1.12244403  ', '1.18685174  '], time:0.01803017ms
         out_f32x4: ['1.12244403  ', '1.18685174  '], time:0.01416922ms
        out_f32_th: ['1.12244391  ', '1.18685174  '], time:0.03599048ms
-------------------------------------------------------------------------------------
           out_f16: ['1.12207031  ', '1.1875      '], time:0.01960206ms
        out_f16_v2: ['1.12207031  ', '1.1875      '], time:0.01966405ms
         out_f16x2: ['1.12207031  ', '1.1875      '], time:0.01323795ms
      out_f16x2_v2: ['1.12207031  ', '1.1875      '], time:0.01328325ms
         out_f16x8: ['1.12207031  ', '1.1875      '], time:0.01214433ms
     out_f16x8pack: ['1.12207031  ', '1.1875      '], time:0.01126909ms
        out_f16_th: ['1.12304688  ', '1.1875      '], time:0.02752280ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=2048
           out_f32: ['-0.23307301 ', '1.85350859  '], time:0.02529573ms
         out_f32x4: ['-0.23307301 ', '1.85350859  '], time:0.02072477ms
        out_f32_th: ['-0.23307301 ', '1.85350859  '], time:0.05042148ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.23303223 ', '1.85449219  '], time:0.02539396ms
        out_f16_v2: ['-0.23303223 ', '1.85449219  '], time:0.02533841ms
         out_f16x2: ['-0.23303223 ', '1.85449219  '], time:0.02242613ms
      out_f16x2_v2: ['-0.23303223 ', '1.85449219  '], time:0.02235413ms
         out_f16x8: ['-0.23303223 ', '1.85449219  '], time:0.01639509ms
     out_f16x8pack: ['-0.23303223 ', '1.85449219  '], time:0.01468873ms
        out_f16_th: ['-0.23303223 ', '1.85253906  '], time:0.03469920ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=4096
           out_f32: ['-0.27824429 ', '-0.27728418 '], time:0.19854450ms
         out_f32x4: ['-0.27824429 ', '-0.27728418 '], time:0.19755340ms
        out_f32_th: ['-0.27824432 ', '-0.27728418 '], time:0.47967172ms
-------------------------------------------------------------------------------------
           out_f16: ['-0.27807617 ', '-0.27734375 '], time:0.04267859ms
        out_f16_v2: ['-0.27807617 ', '-0.27734375 '], time:0.04279613ms
         out_f16x2: ['-0.27807617 ', '-0.27734375 '], time:0.04237676ms
      out_f16x2_v2: ['-0.27807617 ', '-0.27734375 '], time:0.04238486ms
         out_f16x8: ['-0.27807617 ', '-0.27734375 '], time:0.03014469ms
     out_f16x8pack: ['-0.27807617 ', '-0.27734375 '], time:0.02123880ms
        out_f16_th: ['-0.27832031 ', '-0.27734375 '], time:0.04933286ms
-------------------------------------------------------------------------------------