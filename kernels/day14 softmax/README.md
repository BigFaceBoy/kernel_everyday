# softmax
- softmax_f32_per_token_kernel(per token)
- softmax_f32x4_per_token_kernel(per token)
- safe_softmax_f32_per_token_kernel(per token)
- safe_softmax_f32x4_per_token_kernel(per token)
- safe_softmax_f16_f32_per_token_kernel(per token)
- safe_softmax_f16x2_f32_per_token_kernel(per token)
- safe_softmax_f16x8_pack_f32_per_token_kernel(per token)
- online_safe_softmax_f32_per_token_kernel(per token, online softmax)
- online_safe_softmax_f32x4_pack_per_token_kernel(per token, online softmax)

关于softmax的计算及优化，可以参考[From Online Softmax to FlashAttention](https://courses.cs.washington.edu/courses/cse599m/23sp/notes/flashattn.pdf)
# 标准softmax
对于 $x = \{ x_1,x_2,x_3, ... ,x_n \}$

$$
l(x) = \sum_{i = 1}^{n}e^{x_i}
$$

$$
softmax(x_i) = {\frac{e^{x_1}}{l(x)}}
$$

# safe-softmax
$$
m=\max_i x_i = max(x_1,x_2,...,x_n) $$

$$l(x) = \sum_{i = 1}^{n}e^{x_i -m} $$
$$ softmax(x_i) = {\frac{e^{x_1 - m}}{l(x)}}
$$

# online softmax
**for** $i \gets 1,N$ **do**  

$$
m_i \gets max(m_{i-1},x_i)$$
$$
d_i^{'} \gets d_{i-1}^{'}e^{m_{i-1}-m_i}+e^{x_i-m_i} 
$$

**end**

**for** $i \gets 1,N$ **do**

$$
softmax(x_i)\gets \frac{e^{x_i-m_N}}{d_N^{'}} 
$$

**end**

但是问题是这个是一个逐元素递归的方式，经过之前的训练，我们是希望能在warp中计算。  
那么在一个warp中，第一次循环，计算(0,31)、(1,30)、...、(15,16);  
第二次循环，计算的是[(0,31),(15,16)]、[(1,30),(14,17)]、...  
那我们重新来推导一下：  
第一次循环，计算(0,31)、(15,16):

$$
m_0 = max(x_0, x_{31}) $$

$$d_0 = e^{x_0 - m_0} + e^{x_{31} - m_0} $$

$$
m_1 = max(x_{15}, x_{16}) $$

$$d_1 = e^{x_{15} - m_1} + e^{x_{16} - m_1} 
$$

第二次循环，计算[(0,31),(15,16)]:

$$
m_{new} = max(m_0, m_1) $$

$$d_{new} = e^{x_0 - m_{new}} + e^{x_{31} - m_{new}} + e^{x_{15} - m_{new}} + e^{x_{16} - m_{new}} $$
$$= \frac{e^{x_0} + e^{x_{31}} + e^{x_{15}} + e^{x_{16}}}{e^{m_{new}}}$$
$$= \frac{d_0e^{m_0} + d_1e^{m_1}}{e^{m_{new}}} 
$$



# benchmark

```
----------------------------------------------------------------------------------------------------
                                             S=4096, H=256
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01135826ms
          out_f32x4(per): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01008749ms
           out_f32(safe): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01323462ms
    out_f32(safe+online): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01221895ms
  out_f32x4(safe+online): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01014948ms
         out_f32x4(safe): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01019478ms
         out_f32_th(per): ['0.0005798   ', '0.00329143  ', '0.00204818  '], time:0.01231432ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00057983  ', '0.00329208  ', '0.00204849  '], time:0.01293659ms
      out_f16x2f32(safe): ['0.00057983  ', '0.00329208  ', '0.00204849  '], time:0.01033068ms
  out_f16x8packf32(safe): ['0.00057983  ', '0.00329208  ', '0.00204849  '], time:0.01023769ms
         out_f16_th(per): ['0.00057983  ', '0.00329208  ', '0.00204849  '], time:0.01166105ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=512
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01432657ms
          out_f32x4(per): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01122236ms
           out_f32(safe): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01884699ms
    out_f32(safe+online): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01634121ms
  out_f32x4(safe+online): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01134872ms
         out_f32x4(safe): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01135111ms
         out_f32_th(per): ['0.00122877  ', '0.00031311  ', '0.005074    '], time:0.01430988ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00122833  ', '0.00031304  ', '0.00507355  '], time:0.02435207ms
      out_f16x2f32(safe): ['0.00122833  ', '0.00031304  ', '0.00507355  '], time:0.01324415ms
  out_f16x8packf32(safe): ['0.00122833  ', '0.00031304  ', '0.00507355  '], time:0.01047373ms
         out_f16_th(per): ['0.00122833  ', '0.00031304  ', '0.00507355  '], time:0.01359224ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=1024
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.02818584ms
          out_f32x4(per): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.01488686ms
           out_f32(safe): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.04058599ms
    out_f32(safe+online): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.03583193ms
  out_f32x4(safe+online): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.01490593ms
         out_f32x4(safe): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.01514673ms
         out_f32_th(per): ['0.00194702  ', '0.00047703  ', '0.00065508  '], time:0.01987457ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00194836  ', '0.00047708  ', '0.00065517  '], time:0.03757954ms
      out_f16x2f32(safe): ['0.00194836  ', '0.00047708  ', '0.00065517  '], time:0.01864433ms
  out_f16x8packf32(safe): ['0.00194836  ', '0.00047708  ', '0.00065517  '], time:0.01136780ms
         out_f16_th(per): ['0.00194836  ', '0.00047708  ', '0.00065517  '], time:0.01655340ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=2048
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00159171  ', '2.676e-05   ', '8.474e-05   '], time:0.02103806ms
         out_f32x4(safe): ['0.00159171  ', '2.676e-05   ', '8.474e-05   '], time:0.02176046ms
  out_f32x4(safe+online): ['0.00159171  ', '2.676e-05   ', '8.474e-05   '], time:0.02141476ms
         out_f32_th(per): ['0.00159171  ', '2.676e-05   ', '8.474e-05   '], time:0.02828360ms
----------------------------------------------------------------------------------------------------
      out_f16x2f32(safe): ['0.00159168  ', '2.676e-05   ', '8.476e-05   '], time:0.03848314ms
  out_f16x8packf32(safe): ['0.00159168  ', '2.676e-05   ', '8.476e-05   '], time:0.01494884ms
         out_f16_th(per): ['0.00159168  ', '2.676e-05   ', '8.476e-05   '], time:0.02442122ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=4096
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00037026  ', '8.071e-05   ', '0.00017524  '], time:0.19265652ms
         out_f32x4(safe): ['0.00037026  ', '8.071e-05   ', '0.00017524  '], time:0.21094799ms
  out_f32x4(safe+online): ['0.00037026  ', '8.071e-05   ', '0.00017524  '], time:0.19282579ms
         out_f32_th(per): ['0.00037026  ', '8.071e-05   ', '0.00017524  '], time:0.19728899ms
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['0.00037026  ', '8.07e-05    ', '0.00017524  '], time:0.02213955ms
         out_f16_th(per): ['0.00037026  ', '8.07e-05    ', '0.00017524  '], time:0.06226301ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['9.245e-05   ', '3.66e-05    ', '0.00046825  '], time:0.19408464ms
         out_f16_th(per): ['9.245e-05   ', '3.66e-05    ', '0.00046825  '], time:0.20943403ms
----------------------------------------------------------------------------------------------------
                                             S=8192, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['0.00042033  ', '1.585e-05   ', '0.00019622  '], time:0.41353226ms
         out_f16_th(per): ['0.00042033  ', '1.585e-05   ', '0.00019622  '], time:0.41378260ms
----------------------------------------------------------------------------------------------------
```